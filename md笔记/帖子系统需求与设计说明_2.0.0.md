# 帖子系统需求与设计说明（2.0.0）

## 一、需求回顾

| 功能点 | 说明 |
|--------|------|
| 帖子 | 发布、浏览；文字 + 图片（可选，最多 3 张）；服务器本地存储；限制格式与大小 |
| 删除与隐藏 | 逻辑删除；管理员可隐藏；普通用户仅可删自己的帖子/评论，管理员可删全部 |
| 点赞 | 用户-帖子一对一；支持点赞/取消；禁止重复点赞 |
| 评论 | 评论与评论回复，仅二级（帖子→评论→回复，无更深层级） |
| 个人空间 | 昵称、头像、邮箱、已发布帖子、收到的评论与点赞统计 |
| 通知信箱 | 帖子收到的评论、点赞通知 + 官方账号发布的公告；支持已读/未读 |
| 官方账号 | 特殊用户，具备发布公告权限 |

---

## 二、已确认的约定（产品/技术决策）

| 项目 | 决定 |
|------|------|
| **登录** | 只需 **学号或邮箱** 任选其一 + **密码**，无需用用户名登录。 |
| **官方与管理员** | **合并为一个角色**：官方号即管理员，既可发公告，也可删全部、隐藏帖子等。角色枚举为 `student \| merchant \| admin`（admin 即官方号）。 |
| **公告通知** | **强制推送**：用户登录时或登录后访问网站时**弹窗展示**未读公告；用户「看过」后标记已读，**不再弹出**。 |
| **头像** | 先设置**默认头像**（如固定 URL 或路径）；允许**用户自行上传**头像并覆盖。 |
| **帖子图片** | 帖子与图片**一对多**，最多 **3 张**，用 **post_images** 表；**本地存储**，用 **Multer**；**类型**：仅 jpg/png/webp；**大小**：≤ 5MB；**文件命名**：`post_<post_id>_<index>.<ext>`，例如 `post_102_1.jpg`、`post_102_2.jpg`。 |
| **帖子删除（2.0.0）** | **不删物理文件**，只做**逻辑删除**帖子（置 `posts.deleted_at`）；帖子关联的图片文件保留在服务器，不删除。 |

---

## 三、username 与 nickname 的区别 / 注册是否还需 username

| 字段 | 含义 | 用途 |
|------|------|------|
| **username** | 账号维度的**唯一标识** | 个人主页路径、@提及、系统内区分用户；通常**注册时填写**，唯一、相对稳定。 |
| **nickname** | **展示用昵称** | 在帖子、评论、个人空间等处显示的名字；可随时修改，可与他人重复（若不做唯一约束）。 |

- **展示优先级**：前端展示时，优先用 **nickname**；若 nickname 为空，则用 **username**；若两者都无（或未设置），可用学号/邮箱脱敏（如 `123***@xmu.edu.my`）。
- **注册时是否还需提供 username**：  
  - **方案 A（推荐）**：注册时**仍要求填 username**（唯一）。登录只用学号或邮箱 + 密码，username 仅用于展示与个人主页等，不参与登录。  
  - **方案 B**：注册时**不再填 username**，仅学号/邮箱 + 密码；username 可设为必填但由系统自动生成（如用学号或邮箱前缀），或允许用户注册后在「个人资料」里补填。  

若不做个人主页路径（如 `/users/xxx`）和 @提及，可采用方案 B，注册项更少；若需要「用户名」作为公开标识，采用方案 A。文档暂按**方案 A**（注册仍提供 username）执行，你确认后可按需改为 B。

---

## 四、数据库组织形式

### 4.1 与现有库的衔接

- 沿用当前 **MySQL** 与 **jack_campus** 库，使用现有 `database.js` 的 `query` 方法。
- **用户体系**：在现有 `users` 表上扩展字段；**登录方式**：支持学号（student_id）或邮箱（email）任选其一 + 密码，无需用 username 登录。
- **角色**：`role` 枚举为 `student | merchant | admin`，**admin 即官方号**（发公告 + 删全部/隐藏帖子等）。

### 4.2 用户表扩展（users）

在现有表上**新增字段**：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `avatar` | VARCHAR(255) NULL | 头像路径（相对上传根路径）；NULL 时前端使用**默认头像** |
| `nickname` | VARCHAR(100) NULL | 昵称，展示用；为空时前端用 username（参见上文「username 与 nickname」） |

- **登录**：登录接口接收「学号或邮箱」+ 密码；按 `student_id` 或 `email` 查用户，**不用 username 登录**。
- **注册**：是否仍要求填 username 见上文「注册时是否还需提供 username」；当前按方案 A（注册仍提供 username）。
- **头像**：默认头像为固定路径；用户上传后更新 `users.avatar`，展示时 `avatar` 为空则用默认头像。
- **role**：在原有 `student`、`merchant` 基础上增加 `admin`（官方号 = 管理员）。

### 4.3 帖子表（posts）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT AUTO_INCREMENT | 主键 |
| user_id | INT NOT NULL | 发帖用户 ID，外键 → users.id |
| content | TEXT NOT NULL | 正文 |
| type | ENUM('normal','announcement') DEFAULT 'normal' | 普通帖 / 公告（仅 role=admin 可发 announcement） |
| deleted_at | TIMESTAMP NULL | 非空表示逻辑删除 |
| hidden_by_admin | TINYINT(1) DEFAULT 0 | 是否被管理员隐藏 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

- 索引建议：`user_id`、`deleted_at`（列表过滤）、`created_at`（排序）、`type`（若需区分公告流）。

### 4.4 帖子图片表（post_images）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT AUTO_INCREMENT | 主键 |
| post_id | INT NOT NULL | 帖子 ID，外键 → posts.id |
| file_path | VARCHAR(500) NOT NULL | 文件名：`post_<post_id>_<index>.<ext>`，如 `post_102_1.jpg` |
| sort_order | TINYINT DEFAULT 0 | 展示顺序，0/1/2 对应最多 3 张 |
| created_at | TIMESTAMP | 上传时间 |

- 约束：同一 `post_id` 下图片数量 ≤ 3；`file_path` 命名规则见下文「图片存储」。
- 索引：`post_id`。

### 4.5 点赞表（post_likes）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| user_id | INT NOT NULL | 用户 ID |
| post_id | INT NOT NULL | 帖子 ID |
| created_at | TIMESTAMP | 点赞时间 |

- 唯一约束：`UNIQUE(user_id, post_id)`，保证一对一、防重复点赞。
- 主键：可用复合主键 `(user_id, post_id)`，或自增 id + 唯一约束。
- 索引：`post_id`（查某帖点赞数）、`user_id`（个人空间统计）。

### 4.6 评论表（comments）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT AUTO_INCREMENT | 主键 |
| post_id | INT NOT NULL | 帖子 ID |
| user_id | INT NOT NULL | 评论者 ID |
| parent_id | INT NULL | 为空表示一级评论；非空为对某条评论的回复（仅二级） |
| content | TEXT NOT NULL | 评论内容 |
| deleted_at | TIMESTAMP NULL | 逻辑删除 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

- 约束：`parent_id` 若非空，则必须存在且其自身 `parent_id` 为 NULL（即只能回复一级评论），应用层或触发器校验。
- 索引：`post_id`、`parent_id`、`user_id`、`deleted_at`。

### 4.7 通知表（notifications）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT AUTO_INCREMENT | 主键 |
| user_id | INT NOT NULL | 接收通知的用户 ID |
| type | ENUM('comment','like','announcement') | 评论 / 点赞 / 公告 |
| is_read | TINYINT(1) DEFAULT 0 | 是否已读；公告「看过」即置 1，不再弹窗 |
| post_id | INT NULL | 关联帖子（评论、点赞、公告均有） |
| comment_id | INT NULL | 关联评论（type=comment 时可为具体评论 id） |
| from_user_id | INT NULL | 触发者（点赞/评论者）；公告可为 admin 用户 id 或 NULL） |
| extra | JSON NULL | 冗余摘要（如评论摘要、公告标题），便于列表与弹窗展示 |
| created_at | TIMESTAMP | 产生时间 |

- **公告强制推送**：新公告对全站用户各插入一条 `type=announcement` 记录；用户登录或访问时，若有未读公告则弹窗展示，用户关闭/确认后将该条（或批量）`is_read=1`，之后不再弹出。
- 索引：`user_id`、`is_read`、`created_at`。

### 4.8 表关系小结

- **users** ← posts（发帖）、post_likes（点赞）、comments（评论）、notifications（接收通知）。
- **posts** ← post_images（1:N，最多 3）、post_likes（N:M 通过中间表）、comments（1:N）。
- **comments**：post_id + parent_id 实现二级结构；删除权限与 posts 一致（本人或 admin）。

---

## 五、图片存储方式（帖子图片）

### 5.1 存储与命名

- **根目录**：项目下固定上传根目录，例如 `uploads/`（加入 `.gitignore`）。
- **帖子图片子目录**：如 `uploads/posts/`（或再按年/月划分子目录，可选）。
- **文件命名（已确认）**：`post_<post_id>_<index>.<ext>`
  - 示例：`post_102_1.jpg`、`post_102_2.png`、`post_102_3.webp`
  - `post_id` 为帖子主键；`index` 为 1、2、3（对应最多 3 张）；`ext` 为 jpg / png / webp 之一。
- 表中 `post_images.file_path` 存**相对路径**（如 `posts/post_102_1.jpg`），便于静态服务或 CDN 前缀拼接。

### 5.2 格式与大小限制

- **允许格式**：仅 **jpg（jpeg）**、**png**、**webp**；**不含 gif**。对应 MIME：`image/jpeg`、`image/png`、`image/webp`。
- **大小**：单张 **≤ 5MB**，超过则拒绝并提示「图片大小不能超过 5MB」。
- 校验在**服务端**完成（Multer + 扩展名校验 + 文件大小校验），不依赖前端。

### 5.3 上传与访问流程

- **上传**：发帖时使用 **multipart/form-data**，`content` + 最多 3 个图片文件；先插入 `posts` 得到 `post_id`，再按 `post_<post_id>_1.<ext>`、`post_<post_id>_2.<ext>` 写入磁盘并插入 `post_images`（`sort_order` 与 index 一致）。
- **访问**：使用 Express `express.static('uploads')`，前端 URL 如：`/uploads/posts/post_102_1.jpg`。
- **与帖子联动**：列表/详情接口关联 `post_images`，按 `sort_order` 排序，将 `file_path` 拼成完整访问 URL。逻辑删帖时不删物理文件（可选后续做清理）。

### 5.4 与帖子的联动

- 发帖接口：接收 `content` + 可选多文件（最多 3 张）。先写 `posts` → 得到 `post_id` → 按命名规则写盘并写 `post_images`。
- **帖子删除（2.0.0）**：只做**逻辑删除**（置 `posts.deleted_at`），**不删物理文件**；帖子关联的图片文件保留在服务器。
- 列表/详情：关联 `post_images`，按 `sort_order` 排序，返回可访问的图片 URL。

---

## 六、接口与权限设计（概要）

- **登录**：接口接收「学号或邮箱」+ 密码；按 student_id 或 email 查用户并校验密码；返回 JWT。无需 username 登录。
- **帖子**：  
  - 发布：登录用户；若 `type=announcement` 仅 `role=admin` 可发。  
  - 列表/详情：支持分页；过滤掉已逻辑删除及 `hidden_by_admin=1` 的帖（admin 可看全部）。  
  - 删除：本人或 admin；仅逻辑删除。  
  - 隐藏：仅 admin，置 `hidden_by_admin=1`。
- **点赞**：登录用户；点赞/取消点赞；`post_likes` 唯一约束防重复。
- **评论**：一级评论 `parent_id=null`；回复仅二级，`parent_id` 指向一级评论；删除为本人或 admin，逻辑删除。
- **个人空间**：`GET /api/users/:id/profile`：昵称、头像（空则默认）、邮箱、已发布帖子（分页）、收到的评论/点赞统计。
- **头像**：默认头像固定路径；`PATCH /api/users/me/avatar` 或类似接口，上传后更新 `users.avatar`。
- **通知**：  
  - `GET /api/notifications`：当前用户的评论/点赞/公告列表，已读/未读、分页。  
  - **未读公告弹窗**：登录后或访问时，`GET /api/notifications?type=announcement&is_read=0`（或专用接口），前端弹窗展示；用户确认后 `PATCH .../read` 标记已读，之后不再弹出。  
  - 写通知：评论→给帖子作者 type=comment；点赞→给帖子作者 type=like；发公告→给全站用户各插一条 type=announcement。

---

## 七、实现顺序建议

1. **登录改造**：登录接口改为「学号或邮箱」+ 密码；JWT 中保留 role（含 admin）。
2. **数据库**：users 增加 avatar、nickname，role 扩展为 student/merchant/admin；新建 posts、post_images、post_likes、comments、notifications。
3. **默认头像**：在 `uploads/` 下放置默认头像文件，前端/接口约定 NULL 时使用该默认图。
4. **头像上传**：Multer 配置头像目录；用户上传接口更新 `users.avatar`。
5. **帖子图片**：上传根目录、Multer（jpg/png/webp、≤5MB）、命名 `post_<post_id>_<index>.<ext>`、写 `post_images`；静态服务 `express.static('uploads')`。
6. **帖子**：发布（含图）、列表、详情、逻辑删除、admin 隐藏；与 post_images、权限联动。
7. **点赞**：点赞/取消、唯一约束、通知写入。
8. **评论**：一级/二级评论、删除、通知写入。
9. **个人空间**：用户资料（含默认头像）+ 帖子列表 + 评论/点赞统计。
10. **通知**：列表、已读、未读公告弹窗接口（登录后拉取未读公告，确认后标记已读）；发公告时全站插入 announcement 记录。
11. **admin**：公告发布、删全部、隐藏帖子权限与接口。
