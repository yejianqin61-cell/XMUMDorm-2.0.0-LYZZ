# 食堂系统设计说明（待确认）

> 创建时间: 2026-02-06  
> 状态: **待确认** — 请确认后再进入开发

---

## 一、需求理解与设计思路

### 1.1 区域与商家

| 需求点 | 理解 | 设计决策 |
|--------|------|----------|
| 食堂固定 4 个区域 | D6、LY3、B1、BELL 为固定枚举，不可增删 | 用 **区域表 `regions`** 预置 4 条数据，便于统一维护与前端展示 |
| 商家注册后只能创建一个店铺 | 一个 merchant 对应一个 shop | **`shops.user_id` 设 UNIQUE**，创建前校验是否已有店铺 |
| 创建店铺时必须选择区域 | 店铺必属某一区域 | **`shops.region_id` 必填**，创建接口必传 |
| 学生按区域浏览商家 | 按区域查该区域下所有商家 | 接口：`GET /api/canteen/regions/:regionId/shops` |
| 点击商家进入商品目录 | 某店铺下所有商品（可按分类展示） | 接口：`GET /api/canteen/shops/:shopId`（含分类与商品概览）或分接口查分类再查商品 |

**补充**：店铺需要「店铺名称」用于展示，创建店铺时除选择区域外，需填写店铺名称。

---

### 1.2 商品与商品分类

| 需求点 | 理解 | 设计决策 |
|--------|------|----------|
| 商家可创建多个商品分类 | 如：主食 / 小吃 / 饮品 | **`product_categories` 表**，`shop_id` + `name`，支持 `sort_order` 排序 |
| 在分类下创建多个商品 | 商品归属某一分类 | **`products.category_id`** 关联分类 |
| 商品字段：名称、文字说明、卖家秀最多 5 张 | 与帖子图片类似，独立存表 | **`products`** 存名称、说明；**`product_images`** 存图片，同一商品最多 5 条，`sort_order` 控制顺序 |
| 商家可编辑/删除商品 | 仅本人店铺下的商品 | 接口校验：当前用户为店铺 owner 方可编辑/删除 |

---

### 1.3 商品详情页与评论系统

| 需求点 | 理解 | 设计决策 |
|--------|------|----------|
| 商品独立详情页 | 展示商品信息 + 卖家秀 + 评论区 | 前端单页；后端提供 `GET /api/canteen/products/:id`（含分类、店铺、图片、评论分页） |
| 评论：学生和商家都可发表 | 不区分身份，统一评论表 | **`product_comments`**，`user_id` 为评论者，可为 student 或 merchant |
| 评级必填，5 档固定 | 夯爆了 / 顶级 / 人上人 / NPC / 拉完了 | **`product_comments.rating`** 用 **ENUM('夯爆了','顶级','人上人','NPC','拉完了')** 存储 |
| 文字必填，≤300 字 | 短文本 | **`product_comments.content` VARCHAR(300)**，应用层校验长度 |
| 图片可选，最多 3 张 | 与帖子评论类似 | **`product_comment_images`** 表，每评论最多 3 张，格式同现有（jpg/png/webp，≤5MB） |
| 评论最多 2 级 | 一级评论 + 回复（不可再嵌套） | **`parent_id`**：NULL=一级，非空=回复某条（仅允许回复一级评论），与帖子评论一致 |
| 商家可回复评论、可评论自己商品 | 无特殊限制 | 评论接口不限制「是否为自己的商品」，仅需登录 |
| 管理员可删任意评论 | 权限校验 | 删除评论接口：本人 或 role=admin 可删；逻辑删除 `deleted_at` |

---

### 1.4 权限与行为（汇总）

| 角色 | 行为 |
|------|------|
| **学生** | 浏览区域 → 区域下商家列表 → 商家商品目录；查看商品详情；对商品发表评论与回复 |
| **商家** | 创建唯一店铺（选区域+店铺名）；创建/编辑/删除分类与商品；对任意商品（含自家）评论与回复 |
| **管理员** | 删除任意商品评论（逻辑删除） |

---

## 二、数据库设计

### 2.1 表结构总览

```
regions                区域（固定 4 条）
shops                  店铺（一商家一店，必选区域）
product_categories     商品分类（属某店铺）
products               商品（属某分类）
product_images        商品卖家秀图片（属某商品，最多 5 张）
product_comments      商品评论（属某商品，支持 parent_id 二级）
product_comment_images  评论图片（属某评论，最多 3 张）
```

### 2.2 区域表 `regions`

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT AUTO_INCREMENT PRIMARY KEY | 主键 |
| code | VARCHAR(20) NOT NULL UNIQUE | 区域代码：D6 / LY3 / B1 / BELL |
| name | VARCHAR(50) NULL | 展示名称（可与 code 一致或中文等） |
| sort_order | TINYINT DEFAULT 0 | 前端展示顺序 |

- 预置数据：`(1,'D6','D6',1), (2,'LY3','LY3',2), (3,'B1','B1',3), (4,'BELL','BELL',4)`  
- 不提供增删接口，仅查询。

---

### 2.3 店铺表 `shops`

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT AUTO_INCREMENT PRIMARY KEY | 主键 |
| user_id | INT NOT NULL UNIQUE | 商家用户 ID，**一个用户只能有一个店铺** |
| region_id | INT NOT NULL | 所属区域 ID |
| name | VARCHAR(100) NOT NULL | 店铺名称 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

- 外键：`user_id` → `users.id`，`region_id` → `regions.id`
- 索引：`region_id`（按区域查商家）、`user_id`（已 UNIQUE）

---

### 2.4 商品分类表 `product_categories`

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT AUTO_INCREMENT PRIMARY KEY | 主键 |
| shop_id | INT NOT NULL | 所属店铺 ID |
| name | VARCHAR(50) NOT NULL | 分类名称（如：主食/小吃/饮品） |
| sort_order | TINYINT DEFAULT 0 | 同店铺内排序 |
| created_at | TIMESTAMP | 创建时间 |

- 外键：`shop_id` → `shops.id`
- 索引：`shop_id`

---

### 2.5 商品表 `products`

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT AUTO_INCREMENT PRIMARY KEY | 主键 |
| category_id | INT NOT NULL | 所属分类 ID |
| name | VARCHAR(200) NOT NULL | 商品名称 |
| description | TEXT NULL | 商品文字说明 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

- 外键：`category_id` → `product_categories.id`
- 索引：`category_id`

---

### 2.6 商品图片表 `product_images`（卖家秀，最多 5 张）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT AUTO_INCREMENT PRIMARY KEY | 主键 |
| product_id | INT NOT NULL | 商品 ID |
| file_path | VARCHAR(500) NOT NULL | 相对路径，如 `products/product_101_1.jpg` |
| sort_order | TINYINT DEFAULT 0 | 顺序 0~4 |
| created_at | TIMESTAMP | 上传时间 |

- 外键：`product_id` → `products.id` ON DELETE CASCADE
- 应用层约束：同一 `product_id` 最多 5 条

---

### 2.7 商品评论表 `product_comments`

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT AUTO_INCREMENT PRIMARY KEY | 主键 |
| product_id | INT NOT NULL | 商品 ID |
| user_id | INT NOT NULL | 评论者 ID |
| parent_id | INT NULL | NULL=一级评论；非空=回复某条评论（仅二级） |
| rating | ENUM('夯爆了','顶级','人上人','NPC','拉完了') NOT NULL | 评级 |
| content | VARCHAR(300) NOT NULL | 文字评论，≤300 字 |
| deleted_at | TIMESTAMP NULL | 逻辑删除时间 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

- 外键：`product_id` → `products.id`，`user_id` → `users.id`，`parent_id` → `product_comments.id`
- 索引：`product_id`、`parent_id`、`user_id`、`deleted_at`
- 应用层：`parent_id` 非空时，只能指向一级评论（即 parent_id 为 NULL 的评论）

---

### 2.8 评论图片表 `product_comment_images`（每评论最多 3 张）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT AUTO_INCREMENT PRIMARY KEY | 主键 |
| comment_id | INT NOT NULL | 评论 ID |
| file_path | VARCHAR(500) NOT NULL | 相对路径，如 `comments/comment_201_1.jpg` |
| sort_order | TINYINT DEFAULT 0 | 0~2 |
| created_at | TIMESTAMP | 上传时间 |

- 外键：`comment_id` → `product_comments.id` ON DELETE CASCADE
- 应用层约束：同一 `comment_id` 最多 3 条

---

### 2.9 ER 关系简图

```
users (已有)
  │ 1
  └── shops (1:1, user_id UNIQUE)
        │ 1
        └── product_categories (1:N)
              │ 1
              └── products (1:N)
                    │ 1
                    ├── product_images (1:N, ≤5)
                    └── product_comments (1:N)
                          │ parent_id → 自引用(二级)
                          └── product_comment_images (1:N, ≤3)

regions (固定 4 条)
  │ 1
  └── shops (N:1, region_id)
```

---

## 三、接口设计（API）

### 3.1 区域（只读）

| 方法 | 路径 | 说明 | 鉴权 |
|------|------|------|------|
| GET | /api/canteen/regions | 获取全部区域列表（4 条） | 否 |

---

### 3.2 店铺

| 方法 | 路径 | 说明 | 鉴权 |
|------|------|------|------|
| POST | /api/canteen/shops | 创建店铺（name, region_id）；商家且无店铺 | 是（merchant） |
| GET | /api/canteen/regions/:regionId/shops | 某区域下商家列表 | 否 |
| GET | /api/canteen/shops/:shopId | 店铺详情（含分类列表、商品数量等） | 否 |
| GET | /api/canteen/shops/me | 当前用户的店铺（商家本人） | 是（merchant） |
| PATCH | /api/canteen/shops/:shopId | 修改店铺信息（如名称）；仅店主 | 是（owner） |

---

### 3.3 商品分类

| 方法 | 路径 | 说明 | 鉴权 |
|------|------|------|------|
| POST | /api/canteen/shops/:shopId/categories | 创建分类（name, sort_order?） | 是（店主） |
| GET | /api/canteen/shops/:shopId/categories | 店铺下分类列表 | 否 |
| PATCH | /api/canteen/categories/:categoryId | 编辑分类 | 是（店主） |
| DELETE | /api/canteen/categories/:categoryId | 删除分类（其下商品需先删或一并处理，见下） | 是（店主） |

**说明**：删除分类时，若存在商品，可约定：不允许删除 / 或级联将商品移到「未分类」或一并软删，需你确认。

---

### 3.4 商品

| 方法 | 路径 | 说明 | 鉴权 |
|------|------|------|------|
| POST | /api/canteen/products | 创建商品（category_id, name, description?, images 最多 5 张）；multipart | 是（店主，且 category 属自己店铺） |
| GET | /api/canteen/shops/:shopId/products | 店铺下商品列表（可按 category_id 筛选） | 否 |
| GET | /api/canteen/products/:productId | 商品详情（含分类、店铺、卖家秀、评论分页） | 否 |
| PATCH | /api/canteen/products/:productId | 编辑商品（含图片增删）；仅店主 | 是（店主） |
| DELETE | /api/canteen/products/:productId | 删除商品（物理删或逻辑删，需确认）；仅店主 | 是（店主） |

---

### 3.5 商品评论

| 方法 | 路径 | 说明 | 鉴权 |
|------|------|------|------|
| POST | /api/canteen/products/:productId/comments | 发表评论（rating, content, parent_id?, images 最多 3 张）；multipart | 是（登录） |
| GET | /api/canteen/products/:productId/comments | 评论列表（分页，二级结构前端拼或后端树形返回） | 否 |
| DELETE | /api/canteen/products/:productId/comments/:commentId | 逻辑删除评论；本人或 admin | 是（本人/admin） |

---

## 四、文件与目录设计

### 4.1 数据库迁移

| 文件 | 说明 |
|------|------|
| migrations/002_canteen_system.sql | 创建 regions、shops、product_categories、products、product_images、product_comments、product_comment_images；预置 4 条 regions |

---

### 4.2 后端

| 文件/目录 | 说明 |
|-----------|------|
| routes/canteen.js | 食堂相关路由统一入口（区域、店铺、分类、商品、评论），按 3.x 小节分块编写；可后续按需拆成多个文件 |
| middleware/upload.js | 扩展：商品图上传（最多 5 张）、评论图上传（最多 3 张）；命名规则：`product_<id>_<index>.<ext>`、`comment_<id>_<index>.<ext>`；目录：`uploads/products/`、`uploads/comments/` |
| server.js | 已挂载 `/api/canteen`，无需改动（若当前挂载为 `/api/canteen`） |

**canteen.js 建议结构（同一文件内分块）**：

- 区域：GET /regions  
- 店铺：POST/GET/PATCH /shops、GET /regions/:regionId/shops、GET /shops/me  
- 分类：POST/GET /shops/:shopId/categories，PATCH/DELETE /categories/:id  
- 商品：POST/GET/PATCH/DELETE /products，GET /shops/:shopId/products  
- 评论：POST/GET/DELETE /products/:productId/comments  

---

### 4.3 上传与静态资源

| 路径 | 说明 |
|------|------|
| uploads/products/ | 商品卖家秀图片，如 product_101_1.jpg |
| uploads/comments/ | 商品评论图片，如 comment_201_1.jpg |
| .gitignore | 已包含 uploads/，无需改 |

---

### 4.4 前端（后续开发时再细化）

- 页面建议：区域列表 → 区域下商家列表 → 商家商品目录（按分类）→ 商品详情（含评论）
- 商家端：我的店铺、分类管理、商品管理（增删改）、商品评论回复
- 与现有 `html/` 风格一致，可新增如 `canteen.html`、`shop.html`、`product-detail.html` 等，具体待前端阶段再定。

---

## 五、待你确认的点

1. **店铺名称**：创建店铺时除「选择区域」外，是否必填「店铺名称」？当前设计为必填 `name`。  
2. **删除分类**：若分类下仍有商品，是禁止删除分类，还是允许删除并同时把商品设为「未分类」（需增加 category_id 可空或默认未分类）？  
3. **商品删除**：商品删除采用物理删除还是逻辑删除（如加 `deleted_at`）？  
4. **评论图片**：格式与大小是否与帖子图片一致（jpg/png/webp，单张 ≤5MB）？当前按一致设计。  
5. **区域展示名**：四个区域是否只用 D6/LY3/B1/BELL 作为展示名，还是需要额外中文名（如「D6 食堂」）？若需要，可在 `regions.name` 里写。  
6. **接口前缀**：是否统一为 `/api/canteen`（如 `/api/canteen/regions`、`/api/canteen/shops`）？当前按此设计。

确认或修改以上点后，可按此文档做迁移脚本与接口实现；若有新增需求（如搜索、价格字段等）也可以一并说明，便于一起纳入设计。

---

**文档结束，待你确认。**
